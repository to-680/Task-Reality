const taskNameInput = document.getElementById("taskName");
const deadlineInput = document.getElementById("deadline");
const totalHoursInput = document.getElementById("totalHours");
const addBtn = document.getElementById("addBtn");
const result = document.getElementById("result");

const taskSelect = document.getElementById("taskSelect");
const deleteBtn = document.getElementById("deleteBtn");

const calendar = document.getElementById("calendar");
const monthTitle = document.getElementById("monthTitle");

let tasks = JSON.parse(localStorage.getItem("tasks")) || [];

const today = new Date();
today.setHours(0, 0, 0, 0);

// ğŸ¨ è‰²ãƒ‘ãƒ¬ãƒƒãƒˆ
const colors = [
  "#6366f1", "#10b981", "#f59e0b", "#ec4899", "#06b6d4", "#8b5cf6"
];

// èª²é¡Œåã‹ã‚‰è‰²ã‚’æ±ºå®š
function getColor(taskName) {
  let hash = 0;
  for (let i = 0; i < taskName.length; i++) {
    hash += taskName.charCodeAt(i);
  }
  return colors[hash % colors.length];
}

addBtn.addEventListener("click", addTask);
deleteBtn.addEventListener("click", deleteTask);

function addTask() {
  const taskName = taskNameInput.value;
  const deadline = new Date(deadlineInput.value);
  const totalHours = Number(totalHoursInput.value);

  if (!taskName || !deadlineInput.value || totalHours <= 0) {
    alert("ã™ã¹ã¦æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }

  deadline.setHours(0, 0, 0, 0);

  const remainingDays =
    Math.ceil((deadline - today) / (1000 * 60 * 60 * 24)) + 1;

  if (remainingDays <= 0) {
    alert("ç· åˆ‡æ—¥ã¯ä»Šæ—¥ä»¥é™ã«ã—ã¦ãã ã•ã„");
    return;
  }

  const hoursPerDay = totalHours / remainingDays;

  // âœ… è¨ˆç®—çµæœè¡¨ç¤ºï¼ˆå¾©æ´»ï¼‰
  result.innerHTML = `
    ğŸ“Œ èª²é¡Œåï¼š${taskName}<br>
    â° æ®‹ã‚Šæ—¥æ•°ï¼š${remainingDays}æ—¥<br>
    ğŸ’» 1æ—¥ã‚ãŸã‚Šå¿…è¦ä½œæ¥­æ™‚é–“ï¼š${hoursPerDay.toFixed(2)}æ™‚é–“<br><br>
    ${hoursPerDay > 3 ? "ğŸ”¥ ã‹ãªã‚Šãƒãƒ¼ãƒ‰ã§ã™" : "ğŸ™‚ ç¾å®Ÿçš„ãªãƒšãƒ¼ã‚¹ã§ã™"}
  `;

  // ğŸ¨ è‰²æ±ºå®šï¼ˆç· åˆ‡ãŒè¿‘ã„ã¨èµ¤ï¼‰
  const baseColor = getColor(taskName);
  const color = remainingDays <= 3 ? "red" : baseColor;

  // æ—¥ã”ã¨ã«èª²é¡Œã‚’ä¿å­˜
  for (let i = 0; i < remainingDays; i++) {
    const date = new Date(today);
    date.setDate(today.getDate() + i);

    tasks.push({
      date: date.toISOString().slice(0, 10),
      hours: hoursPerDay,
      name: taskName,
      color: color
    });
  }

  localStorage.setItem("tasks", JSON.stringify(tasks));
  renderCalendar();
}

// ğŸ—‘ï¸ èª²é¡Œå‰Šé™¤
function deleteTask() {
  const selectedTask = taskSelect.value;
  if (!selectedTask) return;

  const confirmDelete = confirm(`ã€Œ${selectedTask}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`);
  if (!confirmDelete) return;

  tasks = tasks.filter(t => t.name !== selectedTask);

  localStorage.setItem("tasks", JSON.stringify(tasks));
  result.innerHTML = "ğŸ—‘ï¸ èª²é¡Œã‚’å‰Šé™¤ã—ã¾ã—ãŸ";

  renderCalendar();
}

// èª²é¡Œä¸€è¦§ã‚’ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã«åæ˜ 
function updateTaskSelect() {
  taskSelect.innerHTML = "";

  const taskNames = [...new Set(tasks.map(t => t.name))];

  taskNames.forEach(name => {
    const option = document.createElement("option");
    option.value = name;
    option.textContent = name;
    taskSelect.appendChild(option);
  });
}

function renderCalendar() {
  calendar.innerHTML = "";

  const year = today.getFullYear();
  const month = today.getMonth();

  monthTitle.textContent = `${year}å¹´ ${month + 1}æœˆ`;

  const firstDay = new Date(year, month, 1).getDay();
  const lastDate = new Date(year, month + 1, 0).getDate();

  for (let i = 0; i < firstDay; i++) {
    calendar.appendChild(document.createElement("div"));
  }

  for (let day = 1; day <= lastDate; day++) {
    const cell = document.createElement("div");
    cell.className = "day";

    const dateStr = new Date(year, month, day)
      .toISOString()
      .slice(0, 10);

    const dayTasks = tasks.filter(t => t.date === dateStr);
    const totalTime = dayTasks.reduce((sum, t) => sum + t.hours, 0);

    const taskNamesHtml = dayTasks
      .map(t => `<div class="task-name" style="background:${t.color};">
                   ${t.name}
                 </div>`)
      .join("");

    cell.innerHTML = `
      <div class="day-number">${day}</div>
      ${totalTime > 0 ? `<div class="time">åˆè¨ˆ ${totalTime.toFixed(1)}h</div>` : ""}
      ${taskNamesHtml}
    `;

    calendar.appendChild(cell);
  }

  updateTaskSelect();
}

renderCalendar();
